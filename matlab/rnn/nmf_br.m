function [U,V] = nmf_br(Type,A,U,V,alpha,beta,iter1,iter2,iter3,delta)
%function [U1,U2,V] = nmf_br(Type,A,U1,U2,V,alpha,beta,iter1,iter2,iter3,delta,j)

a = ones(size(V,2),1); %?s??U??????
n = size(V,2); %?????T?C?Y;
Va = [V;a'];
IE = ones(n,n); %?S?????v?f??1???s??;


if strcmp(Type,'N_1') %???????????t???x?j?E?X?m????
  % Normal NMF: min_U,V ||A - ([U b] [V 1])|| s.t. U, V >= 0
  %????????
  %????????????????????????????????????????????
  for i = 1:iter1
    U_org = U(:,1:end-1);
    V = V .* (U_org'*A) ./ ((U_org'*U)*Va + beta*V*IE + eps);
    %V = V .* (U_org'*A) ./ ((U_org'*U)*Va + beta*V + eps);
    Va = [V;a'];
    U = U .* (A*Va') ./ (U*(Va*Va') + alpha*U + eps);
  end
  %????????????????????????????????????????????

elseif strcmp(Type,'N_F2') %???????????t???x?j?E?X?m???????o?C?A?X
                           %??????0
  for i = 1:iter1
    U_org = U(:,1:end-1);
    %V = V .* (U_org'*A) ./ ((U_org'*U)*Va + beta*V*IE + eps);
    V = V .* (U_org'*A) ./ ((U_org'*U)*Va + beta*V*I + eps);
    Va = [V;a'];
    UU = U;
    UU(:,end) = 0; %?o?C?A?X??????0???s??
    U = U .* (A*Va') ./ (U*(Va*Va') + alpha*UU + eps);
  end

elseif strcmp(Type,'S_F') %???????????t???x?j?E?X?m????
  % Semi-NMF: min_U,V ||A - U V|| s.t. V >= 0
    %????????????????????????????????????????????
    for i = 1:iter1
      %pre_U = U;%8/9????
      %pre_V = V;
      Vsvd = low_rank_appl(Va,delta);
      R = A - U*Va;
      VVt = Va * Va';
      [m,n] = size(VVt);
      I = eye(m,n);
      %?????w??3?w?????????x????????
      U = U + (((R * Vsvd.V) / Vsvd.S) * Vsvd.U');
      ss = diag(Vsvd.S);
      ss = ss.^2 ./ (alpha+ss.^2);
      U = U*(Vsvd.U*diag(ss)*Vsvd.U');
      %D = pre_U - U;%8/9????
      %U = pre_U - 0.5*D;%8/9????
      %       U = A / V;
      U_org = U(:,1:end-1);
      UtA = U_org'*A;
      UtAp = (abs(UtA) + UtA) / 2;
      UtAm = (abs(UtA) - UtA) / 2;
      UtU = U_org'*U;
      UtUp = (abs(UtU) + UtU) / 2;
      UtUm = (abs(UtU) - UtU) / 2;

      V = V .* sqrt( (UtAp + UtUm*Va + beta*V) ./ ...
      (UtAm + UtUp*Va + beta*V + eps) );
      %D = pre_V - V;%8/9????
      %V = pre_V - 0.5*D;%8/9????
      Va = [V;a'];
      %????????????????????????????????????????????
    end

elseif strcmp(Type,'S_1') %??????????1?m????
  % Semi-NMF: min_U,V ||A - U V|| s.t. V >= 0
    %????????????????????????????????????????????
    for i = 1:iter1
      Vsvd = low_rank_appl(Va,delta);
      R = A - U*Va;
      VVt = Va * Va';
      [m,n] = size(VVt);
      I = eye(m,n);
      %?????w??3?w?????????x????????
      U = U + (((R * Vsvd.V) / Vsvd.S) * Vsvd.U');
      ss = diag(Vsvd.S);
      ss = ss.^2 ./ (alpha+ss.^2);
      U = U*(Vsvd.U*diag(ss)*Vsvd.U');
      %       U = A / V;
      U_org = U(:,1:end-1);
      UtA = U_org'*A;
      UtAp = (abs(UtA) + UtA) / 2;
      UtAm = (abs(UtA) - UtA) / 2;
      UtU = U_org'*U;
      UtUp = (abs(UtU) + UtU) / 2;
      UtUm = (abs(UtU) - UtU) / 2;

      V = V .* sqrt( (UtAp + UtUm*Va + beta*V*IE) ./ ...
      (UtAm + UtUp*Va + beta*V*IE + eps) );
      Va = [V;a'];
      %????????????????????????????????????????????
    end

elseif strcmp(Type,'S_12') %??????????1?m???????o?C?A?X??????0
  %????????????????????????????????????????????
    for i = 1:iter1
      %Vsvd = low_rank_appl(Va,delta);
      R = A - U*Va;
      VVt = Va * Va';
      [m,n] = size(VVt);
      I = eye(m,n);
      %II:?P???s?????E????0???s??
      II = I;
      II(end,:) = 0;
      II(:,end) = 0;
      %?????w??3?w?????????x????????
      %U = U + (((R * Vsvd.V) / Vsvd.S) * Vsvd.U');
      %ss = diag(Vsvd.S);
      %ss = ss.^2 ./ (alpha+ss.^2);
      %U = U*(Vsvd.U*diag(ss)*Vsvd.U');
      %       U = A / V;
      temp = VVt+alpha*II;
      t_svd = low_rank_appl(temp,1e-14);
      %U = (A*Va')/temp;
      U =(((A*Va')*t_svd.V) / t_svd.S) * t_svd.U';

      U_org = U(:,1:end-1);
      UtA = U_org'*A;
      UtAp = (abs(UtA) + UtA) / 2;
      UtAm = (abs(UtA) - UtA) / 2;
      UtU = U_org'*U;
      UtUp = (abs(UtU) + UtU) / 2;
      UtUm = (abs(UtU) - UtU) / 2;

      V = V .* sqrt( (UtAp + UtUm*Va + beta*V*IE) ./ ...
      (UtAm + UtUp*Va + beta*V*IE + eps) );
      Va = [V;a'];
      %????????????????????????????????????????????
    end

elseif strcmp(Type,'NS_F')
  % Nonlinear Semi-NMF: min_U,V ||A - f(U V)|| s.t. V >= 0
    for i = 1:iter1
        usv = low_rank_appl([V;a'],delta);
        U = non_linear_lsq_br('XA',V,usv,A,U,alpha,iter2);

        usv = low_rank_appl(U(:,1:end-1),delta);
        V = non_linear_lsq_br('AX',U,usv,A,V,beta,iter3);
    end

elseif strcmp(Type,'NS2')

  % Nonlinear Semi-NMF: min_U,V ||A - f(U V)|| s.t. V >= 0
    for i = 1:iter1
        usv = low_rank_appl([V;a'],delta);
        U = non_linear_lsq_br('XA2',V,usv,A,U,alpha,iter2);

        usv = low_rank_appl(U(:,1:end-1),delta);
        V = non_linear_lsq_br('AX2',U,usv,A,V,beta,iter3);
    end
    
elseif strcmp(Type,'NS_r')
    lambda = 0;
    for i = 1:iter1
        usv = low_rank_appl(V,delta);
        U = non_linear_lsq_r('XA',V,usv,A,U,lambda,iter2);
        
        usv = low_rank_appl(U,delta);
        V = non_linear_lsq_r('AX',U,usv,A,V,lambda,iter3);
    end
elseif strcmp(Type,'KL') % NMF on KL divergence: min_U,V d(A,UV) s.t. U, V >= 0
    
    for i = 1:iter1
        D = diag(1./(sum(U)+eps));
        V = V .* ((D * U') * (A ./ (U*V+eps)));

        D = diag(1./(sum(V,2)+eps));
        U = U .* ((A ./ (U*V+eps)) * (V' * D));
    end

end

end
